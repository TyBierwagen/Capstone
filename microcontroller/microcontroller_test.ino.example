#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <DHT.h>

// Wi-Fi credentials
const char* ssid = "SSID_NAME";
const char* password = "PASSWORD";

// Function App endpoint so this test sketch bypasses APIM
const char* sensorApiUrl = "https://your-function-app.azurewebsites.net/api/sensor-data";
const char* functionKey = "YOUR_FUNCTION_KEY_HERE";

// Sensor wiring
#define DHT_PIN 15
#define DHT_TYPE DHT11

String deviceId;
String deviceIp;
DHT dht(DHT_PIN, DHT_TYPE);

void setup() {
  Serial.begin(115200);
  delay(500);
  dht.begin();
  connectToWiFi();
  deviceId = WiFi.macAddress();
  deviceIp = WiFi.localIP().toString();

  Serial.println("\n=== ESP32 Sensor (TEST MODE) ===");
  Serial.println("Type 'r' and hit Enter to publish a reading immediately.");
  Serial.print("Device ID: ");
  Serial.println(deviceId);
  Serial.print("Reporting to: ");
  Serial.println(sensorApiUrl);
}

void loop() {
  if (WiFi.status() != WL_CONNECTED) {
    connectToWiFi();
    delay(500);
    return;
  }

  if (Serial.available()) {
    char command = Serial.read();
    if (command == 'r' || command == 'R') {
      readAndSend();
    }
  }

  delay(100);
}

void connectToWiFi() {
  Serial.print("Connecting to Wi-Fi: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  unsigned long start = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - start < 30000) {
    delay(500);
    Serial.print('.');
  }
  if (WiFi.status() == WL_CONNECTED) {
    deviceIp = WiFi.localIP().toString();
    Serial.println("\nWi-Fi connected");
    Serial.print("IP: ");
    Serial.println(deviceIp);
  } else {
    Serial.println("\nUnable to connect to Wi-Fi");
  }
}

void readAndSend() {
  float humidity = dht.readHumidity();
  float temperature = dht.readTemperature();
  if (isnan(humidity) || isnan(temperature)) {
    Serial.println("Failed to read from DHT sensor");
    return;
  }

  Serial.println("\nPublishing reading:");
  Serial.print("  Temperature: ");
  Serial.print(temperature);
  Serial.println(" Â°C");
  Serial.print("  Humidity: ");
  Serial.print(humidity);
  Serial.println(" %");

  sendToApi(temperature, humidity);
}

void sendToApi(float temperature, float humidity) {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("Wi-Fi dropped before upload");
    return;
  }

  HTTPClient http;
  http.begin(sensorApiUrl);
  http.addHeader("Content-Type", "application/json");
  http.addHeader("x-functions-key", functionKey);

  StaticJsonDocument<256> payload;
  payload["deviceId"] = deviceId;
  payload["deviceIp"] = deviceIp;
  payload["temperature"] = temperature;
  payload["humidity"] = humidity;
  payload["timestamp"] = millis();

  String body;
  serializeJson(payload, body);

  Serial.print("Uploading payload: ");
  Serial.println(body);
  int response = http.POST(body);
  if (response > 0) {
    Serial.print("API response: ");
    Serial.println(response);
  } else {
    Serial.print("Upload failed: ");
    Serial.println(http.errorToString(response));
  }
  http.end();
}
